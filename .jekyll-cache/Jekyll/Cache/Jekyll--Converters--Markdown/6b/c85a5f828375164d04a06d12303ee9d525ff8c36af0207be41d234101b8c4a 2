I"9<ul id="markdown-toc">
  <li><a href="#whats-in-the-box-today" id="markdown-toc-whats-in-the-box-today">Whats in the box today?</a></li>
  <li><a href="#my-lab-environment" id="markdown-toc-my-lab-environment">My Lab Environment</a></li>
  <li><a href="#potential-for-improvement" id="markdown-toc-potential-for-improvement">Potential for improvement</a></li>
  <li><a href="#tricky-attribute-mappings-and-transformations-with-microsoft-graph" id="markdown-toc-tricky-attribute-mappings-and-transformations-with-microsoft-graph">Tricky Attribute Mappings and Transformations with Microsoft Graph</a></li>
  <li><a href="#news-from-ignite-2020" id="markdown-toc-news-from-ignite-2020">News from Ignite 2020</a></li>
  <li><a href="#summarize" id="markdown-toc-summarize">Summarize</a></li>
</ul>

<p>Last year at Ignite 2019, Microsoft introduced the Public Preview of Azure AD Cloud Provisioning (CP), wich was available shortly after the event.</p>

<p>One year later, at all-digital Microsoft Ignite 2020, from September, 22-24, Microsoft announced some news in several sessions and talks about that new synchronization method, which is very interesting and make it more and more a complete solution. Microsoft called it  “Public Preview Refresh” and it will be availlable in October 2020.</p>

<h2 id="whats-in-the-box-today">Whats in the box today?</h2>

<p>Check my related article Cloud Provisioning, which also describes the entire Synchronization Story from Microsoft. Yes, it’s not just Cloud Provisioning. There is a lot more with the Microsoft history journey along synchronization. Read the article <a href="http://nothingbutcloud.net/azuread/CP/" target="_blank">here</a>.</p>

<p>The first release of Cloud Provisioning appears very promising and has a couple of valuable features, especially easy setup, central administration from the Azure Portal and disconnected forest support, only to mention three usefull functionalities.</p>

<p>But when we go into details,  we can see that it is not overall complete. What definitly makes sense, since it is Public Preview.</p>

<p>I have checked it in my KBCORP Lab and wanted to share my experiences.</p>

<h2 id="my-lab-environment">My Lab Environment</h2>

<p>The setup of CP in my Lab was very easy. My Main Environment is the KBCORP.DE Domain which has a hybrid config with a P2 Tenant and the synchronisation is done by AAD Connect. I will not change this for testing CP and because of this I brought up a second domain KBACCOUNT.DE to play with CP. In that scenario I can also test how the new synchronization works, in a disconnected forest approach, because there is no trust between KBCORP and KBACCOUNT.</p>

<p>I have two servers in KBACCOUNT with the CP agent installed. How I made the setup doesn’t need to be described here step-by-step, because Microsoft provides a very detailed <a href="https://docs.microsoft.com/en-us/azure/active-directory/cloud-provisioning/tutorial-single-forest" target="_blank">Configuration Guide</a> for setting up Cloud Provisioning.</p>

<p>I decided to start with two servers to see how failover mechanisms are working. I tested it in a various ways, with stopping services, switching off the server etc. The sync cycle of 2 min is held and I can assure you, High Availlability works very reliable.</p>

<p>The accounts from both domains are synchronized into my tenant without any issues. My lab has two registered domain names KBCORP.DE and KBACCOUNT.DE. With this setup I can demonstrate a typical customer scenario, where, for example, another company is taken over or whatever the reason is. Lot’s of reasons are possible here. The point is, that both Active Directory Domains are untrusted.</p>

<p>The existing tenant can be used from the new domain (Company) and the existing AAD Connect setup on KBCORP isn’t touched. I just setup CP in the KBACCOUNT and all the accounts will go into the tenant with having the correct UPN and domain suffix.</p>

<p>Can you imagine what you have to do in that scenarion without CP? Just with AAD Connect? Yes, it can be manifactured and this is what customers do over years. But you must establish a trusted environment where AAD Connect can act between all the domains. Now, with CP, this is not required and the setup is very easy.</p>

<figure>
  <img src="/MyPics/2020-09-24-CP2-IMG1.jpg" style="width:80%" />
  <figcaption>KBCORP Lab from an synchronization perspective</figcaption>
</figure>

<h2 id="potential-for-improvement">Potential for improvement</h2>

<p>In a daily usage of CP you find a couple of things that can be improved. I will not talk about features which are not implemented in the current version, like PTA Support or the not yet implemented Exchange hybrid support. I just want to talk about a few things that I have noticed.</p>

<p>Conspicuous is the Dashboard, where a lot of free space remains for more information and functionalities. It looks like a little empty, under construction. Yes, I know, Public Preview…</p>

<p>I checked the CP environment for logging information, but this seems to be a challenge: the server, where the agent is installed  has two new Eventlogs. <strong>AgentUpdater</strong> and <strong>ProvisioningAgent</strong> logs. Both will not provide detailed informations from the CP services.</p>

<p>Same with the log in the Cloud Provisioning Portal. Here the Admin will find rudimentary informations. Alltogether troubleshooting is a challenge with the logging capabilities at the moment.</p>

<p>At Ignite Microsoft announces improvements with the logging in Cloud Provisioning for the GA version, when this becomes availlable by the end of 2020.</p>

<h2 id="tricky-attribute-mappings-and-transformations-with-microsoft-graph">Tricky Attribute Mappings and Transformations with Microsoft Graph</h2>

<p>One thing, that costs me multiple hours, are the Attribute Mappings and Transformations changes with Cloud Provisioning in the Public Preview</p>

<p>Microsoft describes the entire procedure <a href="https://docs.microsoft.com/de-de/azure/active-directory/cloud-provisioning/concept-attributes#view-the-schema" target="_blank">here</a>. But I want to share my experiences in addition to that article, because a couple of things are not clear (at least in my opinion).</p>

<p>With the CP Setup an App Registation will be created in Azure. This service principal can be used to access the schema, to modify the attribute mappings.</p>

<p>The <a href="https://developer.microsoft.com/de-de/graph/graph-explorer" target="_blank">Microsoft Graph Explorer</a> must be used to setup a couple of queries against the Azure AD. Don’t forget to check the permissions. <strong>Directory.ReadWrite.All</strong> is required here.</p>

<p>The first query we have to use ist to get the <strong>ServicePrincipleID</strong></p>

<div class="language-posh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">https://graph.microsoft.com/beta/serviceprincipals</span><span class="nf">?</span><span class="nv">$filter</span><span class="o">=</span><span class="nx">startswith</span><span class="p">(</span><span class="n">Displayname</span><span class="p">,</span><span class="s1">'kbaccount'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<figure>
  <img src="/MyPics/2020-09-24-CP2-IMG2.png" style="width:80%" />
  <figcaption>Getting ServicePrincipleID</figcaption>
</figure>

<p>The above mentioned article explains how to query the Displayname for a string that starts with ‘Active’ as the ServicePrinciple Name. But keep in mind that the name here is individual and has nothing to do with ‘Active Directory’ for example. When you are not sure what’s the name in your setup ist, check it in the App Registrations. In my case the name was the domain name kbaccount.de what works with the query, as you can see in the example above.</p>

<figure>
  <img src="/MyPics/2020-09-24-CP2-IMG3.png" style="width:80%" />
  <figcaption>Checking App registration</figcaption>
</figure>

<p>The next step is to get the ProvisioningID. For that query the former resulting ServicePrincipleID must be used:</p>

<div class="language-posh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">https://graph.microsoft.com/beta/serviceprincipals/</span><span class="p">{</span><span class="n">Service</span><span class="w"> </span><span class="nx">Principal</span><span class="w"> </span><span class="nx">id</span><span class="p">}</span><span class="n">/synchronization/jobs/</span><span class="w">
</span></code></pre></div></div>

<figure>
  <img src="/MyPics/2020-09-24-CP2-IMG4.png" style="width:90%" />
  <figcaption>Getting ProvisioningID</figcaption>
</figure>

<p>When you have both IDs you can create the last query to get the schema.</p>

<div class="language-posh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">https://graph.microsoft.com/beta/serviceprincipals/</span><span class="p">{</span><span class="n">Service</span><span class="w"> </span><span class="nx">Principal</span><span class="w"> </span><span class="nx">Id</span><span class="p">}</span><span class="n">/synchronization/jobs/</span><span class="p">{</span><span class="n">AD2AAD</span><span class="w"> </span><span class="nx">Provisioning</span><span class="w"> </span><span class="nx">id</span><span class="p">}</span><span class="n">/schema.</span><span class="w">
</span></code></pre></div></div>

<p>Replace the PrincipleID and the ProvisioningID in the query and after executing this the result is displayed in the Browser Window. Copy the output into a editor of your choice and then you can make the modifications in the areas with source and target attribut mappings. Check <a href="https://docs.microsoft.com/de-de/azure/active-directory/cloud-provisioning/how-to-transformation" target="_blank">this article</a> for a step by step guide what needs to be changed here in detail. I will not re-write Microsoft Article topics here. I just want to share my experiences with that method in manipulating the attribute mapping.</p>

<ul>
  <li>Be sure that you use the correct app registration name. It is not something like “active” as a wildcard</li>
  <li>the results in the queries gives you lots of IDs in the browser windows. Check the screen-output above to pick up the correct IDs</li>
  <li>The schema is not really handy. I put it into VSCode and saved the file and the result was a 20MB output.
In my testing the size was <strong>not</strong> a problem in getting the schema and also <strong>not</strong> to transfer it into an editor for changing. The problem what I had was the way back with the PUT Query, like MS describes. After editing the attribute section (see the MS article that I had mentioned above) I copied the entire content into the browser section in MS Graph and I covered a couple of error messages which makes no sense in that context. <strong>when I cleared the Browser cache it worked “sometimes”</strong>. By the way, I experienced this on both, a MacBook and a Windows 10 client</li>
</ul>

<p>Microsoft integrates the possibility to edit attribute mappings directly in the CP Dashboard with the Public Preview Refresh Update. This makes it easy to implement an attribute mapping.</p>

<figure>
  <img src="/MyPics/2020-09-24-CP2-IMG5.png" style="width:90%" />
  <figcaption>New Attribute Mapping Possiblities from Public Preview Refresh Update</figcaption>
</figure>

<p>But the entire procedure of manipulating the scheme, with the information above, and the referenced Microsoft article is not obsolete, because a programatic way is sometimes the better way to make changes. One example could be, when you implement mappings in the lab and when you want to implement it in the production tenant or for other customer. If you will go that way, keep my information above in mind.</p>

<h2 id="news-from-ignite-2020">News from Ignite 2020</h2>

<p>At Ignite Microsoft announces those changes with the following timeline:</p>

<p><u>In Oct, 2020 a Public preview refresh will be availlabe and this contains those additional features:</u></p>

<ul>
  <li>Improved user experience</li>
  <li>Supporting null value fields</li>
  <li>On demand provisioning of single user</li>
  <li>improved troubleshooting experiences</li>
  <li>Accidental Deletes prevention</li>
  <li>Attribute Mapping and transformations in the user interface</li>
</ul>

<p><u>GA should be availlable by the end of the year with the following features</u></p>

<ul>
  <li>Password writeback (SSPR)</li>
  <li>Synchronization of up to 150k AD Objects</li>
  <li>gMSA Support for agent setup</li>
  <li>Improved performance in the initial sync cycle</li>
  <li>Improved Provisioning logs and health Info in the portal</li>
  <li>Azure workbooks for provisioning</li>
  <li>Auto upgrade of provisioning agent</li>
</ul>

<p>Especialy with the monitoring and logging functionalities CP seems to be interesting for daily usage</p>

<h2 id="summarize">Summarize</h2>

<p>I have the CP installed in my Lab now for half a year. To be honest, I will not touch the Sync Feature every day, but whenever I work with it, I see lots of additions and improvements to Azure AD Connect. Definitly not an replacement of the AAD Connect Server but it brings many extensions to an existing hybrid environment, especially when new domains must be integrated into the  existing flow. The GA is also interesting for new setups, when the admin can live without the not included features.</p>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />

<div class="share-box">
<h5>Share this:</h5>

<a class="t" href="https://twitter.com/intent/tweet?text=&amp;url=http://localhost:4000/2020-09-24-CP-Advanced/" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-twitter fa"></i><span> twitter</span></a>

<a class="l" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://localhost:4000/2020-09-24-CP-Advanced/&amp;title=&amp;summary=&amp;source=webjeda" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-linkedin fa"></i><span> linkedin</span></a>

<a class="e" href="mailto:?subject=&amp;body=Check out this site http://localhost:4000/2020-09-24-CP-Advanced/"><i class="fa fa-envelope fa"></i><span> email</span></a>                          
</div>
:ET